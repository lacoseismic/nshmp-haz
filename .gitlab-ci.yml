variables:
  # nshm-fault-sections repo
  FAULT_SECTIONS: nshm-fault-sections

  # nshm-fault-sections git url
  FAULT_SECTIONS_GIT: https://gitlab-ci-token:${CI_JOB_TOKEN}@code.usgs.gov/ghsc/nshmp/${FAULT_SECTIONS}.git

  # Directory of Jacoco html reports
  JACOCO_HTML_DIR: build/reports/jacoco/test/html

  # Path to all Junit html files
  JUNIT_FILES: build/test-results/test/TEST-*.xml

  # nshmp-lib repo
  NSHMP_LIB: nshmp-lib

  # nshmp-lib git url
  NSHMP_LIB_GIT: https://gitlab-ci-token:${CI_JOB_TOKEN}@code.usgs.gov/ghsc/nshmp/${NSHMP_LIB}.git

stages:
  - assemble
  - test

####
# GitLab runner tags
####
.tags:
  tags:
    - development

####
# Download nshmp-lib and nshm-fault-sections
####
.get-lib:
  nshmp-lib: &nshmp-lib |-
    cd ..;
    rm -rf ${NSHMP_LIB};
    git clone ${NSHMP_LIB_GIT};
    cd ${CI_PROJECT_NAME};
  fault-sections: &fault-sections |-
    cd ..;
    rm -rf ${FAULT_SECTIONS};
    git clone ${FAULT_SECTIONS_GIT};
    cd ${CI_PROJECT_NAME};

####
# Build jar file.
####
build project:
  stage: assemble
  image: gradle
  extends: .tags
  only:
    - merge_request
    - master@ghsc/nshmp/nshmp-haz-v2
  before_script:
    - *nshmp-lib
  script:
    - ./gradlew assemble

####
# Run tests.
# Globals:
#   (string) JACOCO_HTML_DIR - Directory of Jacoco html reports
#   (string) JUNIT_FILES - Path to all Junit html files
####
test project:
  stage: test
  image: gradle
  extends: .tags
  only:
    - merge_request
    - master@ghsc/nshmp/nshmp-haz-v2
  coverage: '/Total.*?([0-9]{1,3})%/'
  before_script:
    - *fault-sections
    - *nshmp-lib
  script:
    - ./gradlew check
    - cat ${JACOCO_HTML_DIR}/index.html
  artifacts:
    paths:
      - ${JACOCO_HTML_DIR}
    reports:
      junit: ${JUNIT_FILES}
